<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MikoKaraoke</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="assets/base.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ðŸŽ¤</text></svg>">
</head>
<body>
  <header>
    <h1>ðŸŽ¤ MikoKaraoke</h1>
    <div class="nav">
      <a href="index.html" class="active">Home</a>
      <a href="reports.html">Reports</a>
      <a href="tipping.html">Tipping</a>
      <a href="settings.html">Settings</a>
    </div>
    <div>
      <a class="pill-link" id="tipVenmo" href="#" target="_blank" rel="noopener">ðŸ’¸ Venmo</a>
      <a class="pill-link" id="tipCashApp" href="#" target="_blank" rel="noopener">ðŸ’µ Cash App</a>
    </div>
  </header>

  <main>
    <div class="wrap">
      <div class="feature-box" id="nowBanner">
        <span class="label">Now Featuring:</span>
        <span class="name" id="nowText">â€”</span>
      </div>

      <section class="home-grid">
        <div class="card">
          <div class="section">
            <h2>Join the Queue</h2>
            <label for="name">Name *</label>
            <input id="name" placeholder="Your name" />
            <label for="song">Song (optional)</label>
            <input id="song" placeholder="Song title" />
            <label for="artist">Artist (optional)</label>
            <input id="artist" placeholder="Artist" />
            <label for="contact">Contact (optional)</label>
            <input id="contact" placeholder="Phone/email" />
            <div style="margin-top:10px"><button id="btnJoin">Join Queue</button></div>
            <p id="msg" class="muted" style="margin-top:8px"></p>
          </div>
        </div>

        <div class="card">
          <div class="section">
            <h2>DJ Console</h2>

            <div id="djLock">
              <div class="pin-row">
                <input id="pinInput" type="password" placeholder="Enter admin PIN" style="max-width:220px" />
                <button id="btnUnlock" class="inline">Unlock</button>
              </div>
              <p class="muted" style="margin-top:6px">Default PIN: <code>123456</code> (change it in Settings)</p>
            </div>

            <div id="djUI" class="hidden">
              <div class="toolbar" style="margin-bottom:8px">
                <button id="btnMarkDone" class="inline">âœ… Mark Done</button>
                <button id="btnRefresh" class="inline">â†» Refresh</button>
                <button id="btnLock" class="inline">ðŸ”’ Lock</button>
              </div>
              <div class="table-wrap">
                <table id="queueTable">
                  <thead><tr><th>#</th><th>Name</th><th>Song</th><th>Actions</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <div class="footer">
    <div class="sitemap">
      <a href="index.html">Home</a> Â·
      <a href="reports.html">Reports</a> Â·
      <a href="tipping.html">Tipping</a> Â·
      <a href="settings.html">Settings</a>
    </div>
    <div id="upNext">Up Next: â€”</div>
  </div>

  <script type="module">
    import { supabase, wireTipLinks, setActiveNav, escapeHtml, isSameDay, getPin, setPin, isUnlocked, setUnlocked, unlockWith, setupRealtime } from './assets/shared.js';

    wireTipLinks();
    setActiveNav('index.html');

    // PIN lock UI
    const djLock = document.getElementById('djLock');
    const djUI   = document.getElementById('djUI');
    function updateLockUI(){ if(isUnlocked()){ djLock.classList.add('hidden'); djUI.classList.remove('hidden'); } else { djUI.classList.add('hidden'); djLock.classList.remove('hidden'); } }
    document.getElementById('btnUnlock').onclick = ()=>{ const p=(document.getElementById('pinInput').value||'').trim(); if(unlockWith(p)){ setUnlocked(true); updateLockUI(); } else alert('Incorrect PIN'); };
    document.getElementById('btnLock').onclick = ()=>{ setUnlocked(false); updateLockUI(); };
    updateLockUI();

    // UI refs
    const nameEl   = document.getElementById('name');
    const songEl   = document.getElementById('song');
    const artistEl = document.getElementById('artist');
    const contactEl= document.getElementById('contact');
    const msgEl    = document.getElementById('msg');
    const tbody    = document.querySelector('#queueTable tbody');
    const nowBanner= document.getElementById('nowBanner');
    const nowText  = document.getElementById('nowText');
    const upNextEl = document.getElementById('upNext');
    const btnJoin  = document.getElementById('btnJoin');
    const btnMarkDone = document.getElementById('btnMarkDone');
    const btnRefresh = document.getElementById('btnRefresh');

    btnJoin.onclick = joinQueue;
    btnMarkDone.onclick = markDone;
    btnRefresh.onclick = ()=>{ loadQueue(); loadNowPlaying(); };

    let busy=false; function lock(){ if(busy) return false; busy=true; return true; } function unlock(){ busy=false; }

    async function joinQueue(){
      if(!lock()) return;
      try{
        const name=(nameEl.value||'').trim(); if(!name){ msgEl.textContent='Name is required.'; return; }
        const song=(songEl.value||'').trim(); const artist=(artistEl.value||'').trim(); const contact=(contactEl.value||'').trim();
        const { error } = await supabase.from('signups').insert([{ name, song, artist, contact }]);
        if(error){ msgEl.textContent='Error: '+error.message; return; }
        nameEl.value=songEl.value=artistEl.value=contactEl.value=''; msgEl.textContent="You're in! ðŸŽ‰";
        await loadQueue();
      } finally { unlock(); }
    }

    async function featureRow(row){
      if(!lock()) return;
      try{
        await supabase.from('now_playing').upsert({ id:1, name: row.name, song: row.song||null, artist: row.artist||null, started_at: new Date().toISOString() });
        await supabase.from('signups').delete().eq('id', row.id);
        await Promise.all([loadQueue(), loadNowPlaying()]);
      } finally { unlock(); }
    }

    async function removeSignup(id){
      if(!lock()) return;
      try{ await supabase.from('signups').delete().eq('id', id); await loadQueue(); } finally { unlock(); }
    }

    async function markDone(){
      if(!lock()) return;
      try{
        const { data: np } = await supabase.from('now_playing').select('*').eq('id',1).maybeSingle();
        if(np?.name){ await supabase.from('history').insert([{ name: np.name, song: np.song||null, artist: np.artist||null }]); }
        await supabase.from('now_playing').update({ name:null, song:null, artist:null, started_at:null }).eq('id',1);
        await Promise.all([loadQueue(), loadNowPlaying()]);
      } finally { unlock(); }
    }

    async function loadQueue(){
      const { data, error } = await supabase.from('signups').select('*').order('created_at', { ascending:true });
      if(error) return;
      const nextName = data && data.length ? data[0].name : null;
      upNextEl.textContent = `Up Next: ${nextName ? nextName : 'â€”'}`;
      tbody.innerHTML='';
      (data||[]).forEach((row,i)=>{
        const tr=document.createElement('tr');
        const name=escapeHtml(row.name);
        const song=row.song?escapeHtml(row.song):'<span class="muted">â€”</span>';
        tr.innerHTML = `<td>${i+1}</td><td>${name}</td><td>${song}</td><td></td>`;
        const actions=document.createElement('div');
        const b1=document.createElement('button'); b1.className='inline'; b1.textContent='Feature'; b1.onclick=()=>featureRow(row);
        const b2=document.createElement('button'); b2.className='inline'; b2.style.marginLeft='6px'; b2.textContent='Remove'; b2.onclick=()=>removeSignup(row.id);
        actions.appendChild(b1); actions.appendChild(b2); tr.lastChild.appendChild(actions); tbody.appendChild(tr);
      });
    }

    async function loadNowPlaying(){
      const { data } = await supabase.from('now_playing').select('*').eq('id',1).maybeSingle();
      if(data?.started_at && !isSameDay(new Date(data.started_at), new Date())){
        await supabase.from('now_playing').update({ name:null, song:null, artist:null, started_at:null }).eq('id',1);
        nowText.textContent='â€”'; return;
      }
      const prev=nowText.textContent; const current=data?.name?data.name:'â€”'; nowText.textContent=current;
      if(current!==prev){ nowBanner.classList.remove('pulse'); void nowBanner.offsetWidth; nowBanner.classList.add('pulse'); }
    }

    // realtime + polling fallback
    let lastRealtimeAt = 0; function bump(){ lastRealtimeAt=Date.now(); }
    setupRealtime({
      onSignups: () => { bump(); loadQueue(); },
      onNow:     () => { bump(); loadNowPlaying(); },
    });
    bump();
    const POLL_MS=10000;
    setInterval(async()=>{ const quiet=Date.now()-lastRealtimeAt>POLL_MS-500; if(!quiet) return; await Promise.all([loadQueue(), loadNowPlaying()]); },POLL_MS);
    document.addEventListener('visibilitychange',()=>{ if(!document.hidden) bump(); });

    // init
    wireTipLinks();
    await Promise.all([loadQueue(), loadNowPlaying()]);
  </script>
</body>
</html>
